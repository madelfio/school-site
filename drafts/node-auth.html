<!DOCTYPE html>
<html lang="en">
<head>
  <title>How to add OAuth to a Node.js app using Passport</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <link rel="stylesheet" href="http://umiacs.umd.edu/~marco/theme/css/marco.css" type="text/css" />
  <link href="http://umiacs.umd.edu/~marco/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Marco D. Adelfio Atom Feed" />

  <!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!--[if lte IE 7]>
  <link rel="stylesheet" type="text/css" media="all" href="http://umiacs.umd.edu/~marco/css/ie.css"/>
  <script src="http://umiacs.umd.edu/~marco/js/IE8.js" type="text/javascript"></script><![endif]-->

  <!--[if lt IE 7]>
  <link rel="stylesheet" type="text/css" media="all" href="http://umiacs.umd.edu/~marco/css/ie6.css"/><![endif]-->

  <script>var siteurl = "http://umiacs.umd.edu/~marco";</script>
</head>

<body id="index" class="home">
  <header id="banner">
  <h1><a href="http://umiacs.umd.edu/~marco/">Marco D. Adelfio </a></h1>
  <nav><ul>
    <li><a href="http://umiacs.umd.edu/~marco/projects">Projects</a></li>
    <li><a href="http://umiacs.umd.edu/~marco/publications">Publications</a></li>
    <li><a href="http://umiacs.umd.edu/~marco/links">Links</a></li>
    <li><a href="http://umiacs.umd.edu/~marco/about">About</a></li>
  </ul></nav>
  </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header class="entry-header">
      <h1 class="entry-title">
        <a href="http://umiacs.umd.edu/~marco/notes/node-auth" rel="bookmark"
           title="Permalink to How to add OAuth to a Node.js app using Passport">How to add OAuth to a Node.js app using Passport</a></h1>
    </header>

    <div class="entry-content">
      <p>I want to have usernames and sessions in some node.js apps.  Here's how I set
it up using <a href="http://passportjs.org/">Passport</a> (which has a user guide, including a <a href="http://passportjs.org/guide/google/">section on
Google OpenID</a>, but does not seem to have a cookbook-like tutorial for getting
everything set up).</p>
<h2>Install</h2>
<p>First install Passport and the Google "Strategy" (not a fan of this name).
You can install other strategies from the list here if you have other OpenID
endpoints to use:</p>
<div class="highlight"><pre><span class="gp">$</span> npm install passport passport-google
</pre></div>


<h2>Files</h2>
<p>You will be editing app.js and adding several files to your app:</p>
<div class="highlight"><pre><span class="go">./my-app</span>
<span class="go">├── app.js  (Modify existing)</span>
<span class="go">├── auth.js</span>
<span class="go">├── public</span>
<span class="go">│   └── images</span>
<span class="go">│       └── google.png</span>
<span class="go">└── views</span>
<span class="go">    ├── login.ejs</span>
<span class="go">    └── unauthorized.ejs</span>
</pre></div>


<h3>app.js</h3>
<p>In app.js, we (1) require auth.js:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
    <span class="p">...</span>
    <span class="cm">/* Authentication */</span>
    <span class="nx">auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./auth&#39;</span><span class="p">);</span>
</pre></div>


<p>(2) initialize it:</p>
<div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">setup</span><span class="p">());</span>
</pre></div>


<p>(3) add routes:</p>
<div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/google&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">google</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/google/return&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">google_return</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;/login&#39;</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">logout</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">unauthorized</span><span class="p">());</span>
</pre></div>


<p>(4) require authentication for some pages (if necessary):</p>
<div class="highlight"><pre><span class="cm">/* existing routes */</span>
<span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(&#39;</span><span class="o">/</span><span class="n">some_page</span><span class="p">&#39;,</span> <span class="n">auth</span><span class="p">.</span><span class="n">check</span><span class="p">(),</span> <span class="n">some_route_func</span><span class="p">);</span>
</pre></div>


<h3>auth.js</h3>
<p>We put all the real logic and interface with passport and passport-google in
auth.js.</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport&#39;</span><span class="p">),</span>
    <span class="nx">GoogleStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-google&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">returnURL</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/auth/google/return&#39;</span><span class="p">,</span>
    <span class="nx">realm</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/&#39;</span><span class="p">,</span>
    <span class="nx">goog_auth_settings</span> <span class="o">=</span> <span class="p">{</span><span class="nx">returnURL</span><span class="o">:</span> <span class="nx">returnURL</span><span class="p">,</span> <span class="nx">realm</span><span class="o">:</span> <span class="nx">realm</span><span class="p">},</span>
    <span class="nx">authHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">profile</span><span class="p">.</span><span class="nx">identifier</span> <span class="o">=</span> <span class="nx">identifier</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">profile</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);});</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);});</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">GoogleStrategy</span><span class="p">(</span><span class="nx">goog_auth_settings</span><span class="p">,</span> <span class="nx">authHandler</span><span class="p">));</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">setup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">google</span> <span class="o">=</span>
</pre></div>


<p>First, require passport, passport-google (or other strategies), and the
soon-to-be-created <code>auth.js</code>:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
    <span class="p">...</span>
    <span class="cm">/* Authentication */</span>
    <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport&#39;</span><span class="p">),</span>
    <span class="nx">GoogleStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-google&#39;</span><span class="p">),</span>
    <span class="nx">auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./auth&#39;</span><span class="p">);</span>
</pre></div>


<p>You need to enable the GoogleStrategy by adding this before setting up Express
to use Passport.  This simply saves the username in profile.identifier and
does not persist it to storage:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">returnURL</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/auth/google/return&#39;</span><span class="p">,</span>
    <span class="nx">realm</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/&#39;</span><span class="p">,</span>
    <span class="nx">goog_auth_settings</span> <span class="o">=</span> <span class="p">{</span><span class="nx">returnURL</span><span class="o">:</span> <span class="nx">returnURL</span><span class="p">,</span> <span class="nx">realm</span><span class="o">:</span> <span class="nx">realm</span><span class="p">},</span>
    <span class="nx">authHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">identifier</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">profile</span><span class="p">.</span><span class="nx">identifier</span> <span class="o">=</span> <span class="nx">identifier</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">profile</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);});</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span><span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);});</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">GoogleStrategy</span><span class="p">(</span><span class="nx">goog_auth_settings</span><span class="p">,</span> <span class="nx">authHandler</span><span class="p">));</span>
</pre></div>


<p>Add these lines to enable passport, after a call to
<code>app.use(express.session())</code> (Marco: is <code>express.session()</code> required?):</p>
<div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">setup</span><span class="p">);</span>
</pre></div>


<p>Then add these among/after your routes:</p>
<div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/google&#39;</span><span class="p">,</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">failureRedirect</span><span class="o">:</span> <span class="s1">&#39;/site/login&#39;</span><span class="p">});</span>
<span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth/google/return&#39;</span><span class="p">,</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;google&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">successReturnToOrRedirect</span><span class="o">:</span> <span class="s1">&#39;/site/&#39;</span><span class="p">,</span>
    <span class="nx">failureRedirect</span><span class="o">:</span> <span class="s1">&#39;/site/login&#39;</span>
  <span class="p">}),</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/site/&#39;</span><span class="p">);}</span>
<span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">logout</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/unauthorized&#39;</span><span class="p">,</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">unauthorized</span><span class="p">);</span>
</pre></div>
<footer class="post-info">
        Posted:
        <abbr class="published" title="2013-03-15T16:19:00">
                Mar 15, 2013
        </abbr>


</footer><!-- /.post-info -->    </div><!-- /.entry-content -->

  </article>
</section>
  <section id="extras" class="body">
  </section><!-- /#extras -->

  <footer id="contentinfo" class="body">
  </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9669059-5']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
    <!-- Start of StatCounter Code for Default Guide -->
    <script type="text/javascript">
      var sc_project=8544392;
      var sc_invisible=1;
      var sc_security="d727ef73";
      var scJsHost = (("https:" == document.location.protocol) ?  "https://secure." : "http://www.");
      document.write("<sc"+"ript type='text/javascript' src='" + scJsHost + "statcounter.com/counter/counter.js'></"+"script>");
    </script>
    <noscript>
      <div class="statcounter">
        <a title="site stats" href="http://statcounter.com/" target="_blank">
          <img class="statcounter" src="http://c.statcounter.com/8544392/0/d727ef73/1/" alt="site stats">
        </a>
      </div>
    </noscript>
    <!-- End of StatCounter Code for Default Guide -->
</body>
</html>